from zhipuai import ZhipuAI
import os
from django.http import JsonResponse
from django.views.decorators.http import require_http_methods
import json

API_KEY = os.getenv("1af4f35363ea97ed269ee3099c04f7f3.3AGroi22UtegCtjf", "1af4f35363ea97ed269ee3099c04f7f3.3AGroi22UtegCtjf")
client = ZhipuAI(api_key=API_KEY)

# å®šä¹‰ä¸åŒå¹³å°çš„æç¤ºæ¨¡æ¿
PLATFORM_PROMPTS = {
    # ä¸€ã€ç¤¾äº¤ç§è‰å¹³å°
    "å°çº¢ä¹¦": lambda title, tags, content: f"""ä½œä¸ºèµ„æ·±æ¹–æ¹˜æ–‡åŒ–ä¼ æ’­ç­–åˆ’å¸ˆï¼Œè¯·ä¼˜åŒ–ä»¥ä¸‹å†…å®¹ä»¥é€‚åº”å¹´è½»åŒ–ä¼ æ’­ï¼š
ğŸ“Œ æ ‡é¢˜ï¼š{title}ï¼ˆè¦æ±‚ï¼šåŠ å…¥ç½‘ç»œçƒ­è¯+æ‚¬å¿µè®¾ç½®ï¼‰
ğŸ·ï¸ æ ‡ç­¾ï¼šä¸»æ ‡ç­¾#{tags}ï¼Œè¾…æ ‡ç­¾#ä½“éªŒæ‰“å¡+#éé—ä¼ æ‰¿
ğŸ“º å½¢å¼ï¼šéœ€åŒ…å«3ä¸ªæ‹ç…§æ‰“å¡ç‚¹å»ºè®®+1ä¸ªäº’åŠ¨é—®é¢˜
ğŸ“¢ æ¸ é“ï¼šå°çº¢ä¹¦ï¼Œè°ƒæ€§ï¼šè½»æ¾æ´»æ³¼+çŸ¥è¯†å¹²è´§
ğŸ“ åŸå§‹å†…å®¹ï¼š{content}
âœï¸ ä¼˜åŒ–è¦æ±‚ï¼šæ¯æ®µæ·»åŠ 1ä¸ªè¡¨æƒ…ç¬¦å·ï¼Œä½¿ç”¨"ä½ "çš„ç¬¬äºŒäººç§°ï¼Œç»“å°¾è®¾è®¡2ä¸ªè¯é¢˜è®¨è®º""",

    "å¾®åš": lambda title, tags, content: f"""ä½œä¸ºèµ„æ·±æ¹–æ¹˜æ–‡åŒ–ä¼ æ’­ç­–åˆ’å¸ˆï¼Œè¯·ä¼˜åŒ–ä»¥ä¸‹å†…å®¹ä»¥é€‚åº”å¾®åšä¼ æ’­ï¼š
ğŸ“Œ æ ‡é¢˜ï¼š{title}ï¼ˆè¦æ±‚ï¼šçƒ­æœå¼æ ‡é¢˜+è¯é¢˜å¼•å¯¼ï¼‰
ğŸ·ï¸ æ ‡ç­¾ï¼šä¸»è¯é¢˜#{tags}#ï¼Œé…åˆ3-5ä¸ªç›¸å…³è¯é¢˜
ğŸ“± å½¢å¼ï¼šå›¾æ–‡ç»“åˆï¼Œé…å›¾æ–‡æ¡ˆç‚¹é¢˜
ğŸ“¢ è°ƒæ€§ï¼šç®€çŸ­æœ‰åŠ›ï¼Œçªå‡ºä¼ æ’­æ€§ï¼Œè®¾ç½®äº’åŠ¨æœºåˆ¶
ğŸ“ åŸå§‹å†…å®¹ï¼š{content}
âœï¸ ä¼˜åŒ–è¦æ±‚ï¼šæ§åˆ¶åœ¨140å­—å†…ï¼Œè®¾è®¡2-3ä¸ªäº’åŠ¨è¯é¢˜ï¼Œå¢åŠ è½¬å‘æ¿€åŠ±""",

    # äºŒã€çŸ­è§†é¢‘å¹³å°
    "æŠ–éŸ³": lambda title, tags, content: f"""è¯·ä»¥çŸ­è§†é¢‘è„šæœ¬å½¢å¼é‡æ„å®£ä¼ å†…å®¹ï¼š
ğŸ¬ æ ‡é¢˜ï¼š{title}ï¼ˆè¦æ±‚ï¼šè®¾ç½®å†²çª/åè½¬ï¼Œå¦‚"99%çš„äººä¸çŸ¥é“çš„...")
ğŸ“Œ ä¿¡æ¯ç‚¹ï¼šéœ€çªå‡º{tags}çš„è§†è§‰å†²å‡»åŠ›
â±ï¸ ç»“æ„ï¼šé»„é‡‘3ç§’æ‚¬å¿µ+15ç§’æ ¸å¿ƒå±•ç¤º+5ç§’è¡ŒåŠ¨å·å¬
ğŸµ é€‚é…éŸ³ä¹ï¼šå»ºè®®3ç§BGMç±»å‹ï¼ˆå¦‚ï¼šå›½é£ç”µå­/ä¼ ç»Ÿæ°‘ä¹æ”¹ç¼–ï¼‰
ğŸ’¬ äº’åŠ¨è®¾è®¡ï¼šç»“å°¾éœ€åŒ…å«æŒ‘æˆ˜èµ›è¯é¢˜æˆ–æ‰“å¡ä»»åŠ¡
ğŸ“ åŸå§‹ç´ æï¼š{content}
ğŸ”§ ä¿®æ”¹è¦æ±‚ï¼šæ¯20å­—æ¢è¡Œï¼Œå…³é”®ä¿¡æ¯é‡å¤å¼ºè°ƒï¼ŒåŠ å…¥å£è¯­åŒ–çƒ­æ¢—""",

    "Bç«™": lambda title, tags, content: f"""è¯·ä»¥Bç«™è§†é¢‘è„šæœ¬å½¢å¼é‡æ„å®£ä¼ å†…å®¹ï¼š
ğŸ¬ æ ‡é¢˜ï¼š{title}ï¼ˆè¦æ±‚ï¼šç§‘æ™®å‘+å¹²è´§æ„Ÿï¼‰
ğŸ“Œ åˆ†åŒºï¼šæ–‡åŒ–/äººæ–‡å†å²
â±ï¸ ç»“æ„ï¼šå¼€åœºåˆ›æ„+å¹²è´§ä¸»ä½“+äº’åŠ¨å¼•å¯¼ï¼Œå»ºè®®æ—¶é•¿5-7åˆ†é’Ÿ
ğŸ¨ é£æ ¼ï¼šç¡¬æ ¸ç§‘æ™®+è¶£å‘³è§£è¯´ï¼Œå¯åŠ å…¥åŠ¨ç”»å…ƒç´ 
ğŸ“ åŸå§‹ç´ æï¼š{content}
ğŸ”§ ä¿®æ”¹è¦æ±‚ï¼šåŠ å…¥ä¸“ä¸šçŸ¥è¯†ç‚¹ï¼Œè®¾è®¡å¼¹å¹•äº’åŠ¨ç‚¹ï¼Œç»“å°¾è®¾ç½®æ‚¬å¿µ""",

    # ä¸‰ã€æ”¿åŠ¡å‘å¸ƒå¹³å°
    "æ”¿åºœå¹³å°": lambda title, tags, content: f"""è¯·å°†å†…å®¹è½¬åŒ–ä¸ºæ”¿åŠ¡ä¿¡æ¯é€šæŠ¥æ ¼å¼ï¼š
ğŸ›ï¸ å‘æ–‡å•ä½ï¼šæ¹–å—çœæ–‡åŒ–å’Œæ—…æ¸¸å…ï¼ˆéœ€å‰ç½®ï¼‰
ğŸ“œ æ”¿ç­–ä¾æ®ï¼šåŠ å…¥ã€Šæ–‡åŒ–ä¿æŠ¤ä¸ä¼ æ‰¿ç›¸å…³æ”¿ç­–ã€‹æ¡ç›®
â­ æ ¸å¿ƒè¦ç´ ï¼šçªå‡ºæ–‡åŒ–ä¿æŠ¤æˆæœ+æƒ æ°‘æªæ–½
ğŸ“Š æ•°æ®æ”¯æ’‘ï¼šéœ€è¡¥å……å‚ä¸äººæ¬¡/èµ„é‡‘æŠ•å…¥/ä¿æŠ¤æˆæœç­‰æ•°æ®
ğŸ“ åŸå§‹ææ–™ï¼š{content}
âœ’ï¸ ä¿®æ”¹è¦æ±‚ï¼šä½¿ç”¨ä»¿å®‹å­—ä½“åˆ†æ®µï¼Œä¸“ä¸šæœ¯è¯­è§„èŒƒï¼Œæ·»åŠ 2å¤„é¢†å¯¼è®²è¯å¼•ç”¨""",

    "å…šå»ºå¹³å°": lambda title, tags, content: f"""è¯·å°†å†…å®¹è½¬åŒ–ä¸ºå…šå»ºå®£ä¼ æ ¼å¼ï¼š
ğŸ›ï¸ ä¸»é¢˜ï¼šå¼˜æ‰¬ä¼ ç»Ÿæ–‡åŒ–ï¼Œè·µè¡Œç¤¾ä¼šä¸»ä¹‰æ ¸å¿ƒä»·å€¼è§‚
ğŸ“œ ç†è®ºä¾æ®ï¼šä¹ è¿‘å¹³æ€»ä¹¦è®°å…³äºæ–‡åŒ–å»ºè®¾çš„é‡è¦è®ºè¿°
â­ é‡ç‚¹ï¼šçªå‡ºå…šçš„é¢†å¯¼ã€ç¾¤ä¼—è·¯çº¿ã€æ–‡åŒ–è‡ªä¿¡
ğŸ“Š æˆæœå±•ç¤ºï¼šæ–‡åŒ–ä¼ æ‰¿ä¸åˆ›æ–°çš„å…·ä½“å®è·µ
ğŸ“ åŸå§‹ææ–™ï¼š{content}
âœ’ï¸ ä¿®æ”¹è¦æ±‚ï¼šçªå‡ºæ”¿æ²»æ€§ã€æ€æƒ³æ€§ï¼Œç»“åˆæ—¶ä»£ç‰¹è‰²""",

    # å››ã€æ–°é—»åª’ä½“æŠ¥é“
    "æ–°é—»åª’ä½“": lambda title, tags, content: f"""è¯·æŒ‰æ–°é—»é€šç¨¿æ ‡å‡†æ”¹å†™ï¼š
ğŸ“° æ ‡é¢˜ï¼š{title}ï¼ˆå‰¯æ ‡é¢˜ï¼šå±•ç°æ–‡åŒ–åˆ›æ–°äº®ç‚¹ï¼‰
ğŸ” æ–°é—»è¦ç´ ï¼š5W1HåŸåˆ™éœ€å®Œæ•´å‘ˆç°
ğŸ‘¥ é‡‡è®¿å¯¹è±¡ï¼šåŠ å…¥ä¼ æ‰¿äºº+å¸‚æ°‘+ä¸“å®¶ä¸‰æ–¹è§†è§’
ğŸ“· é…å›¾å»ºè®®ï¼šæè¿°3ä¸ªå…³é”®ç”»é¢æ‹æ‘„å»ºè®®
ğŸ“ åŸå§‹èµ„æ–™ï¼š{content}
âœï¸ ä¿®æ”¹æ–¹å‘ï¼šé‡‡ç”¨å€’é‡‘å­—å¡”ç»“æ„ï¼Œé¦–æ®µåŒ…å«æ ¸å¿ƒä¿¡æ¯ï¼ŒåŠ å…¥2å¤„ç›´æ¥å¼•è¯­""",

    # äº”ã€è¡¥å……æ¨¡æ¿ç±»å‹
    "æµ·å¤–ä¼ æ’­": lambda title, tags, content: f"""è¯·ç”Ÿæˆé€‚åˆæµ·å¤–ç¤¾äº¤å¹³å°çš„æ–‡æ¡ˆï¼š
ğŸŒ å¹³å°ï¼šInstagram/Facebook
ğŸ¨ æ–‡åŒ–ç¬¦å·ï¼šéœ€è¯´æ˜{tags}çš„å›½é™…å¯¹åº”ç‰©
ğŸ¯ ç›®æ ‡ï¼šçªå‡ºä¸­å›½æ–‡åŒ–ç‰¹è‰²ï¼Œä¿ƒè¿›æ–‡åŒ–äº’é‰´
ğŸ“ åŸå§‹å†…å®¹ï¼š{content}
âœï¸ è¦æ±‚ï¼šä¸­è‹±åŒè¯­ï¼Œé…è‰²æ–¹æ¡ˆéœ€ç¬¦åˆå›½é™…å®¡ç¾ï¼Œçªå‡ºè§†è§‰å†²å‡»åŠ›""",

    "çº¿ä¸‹ç‰©æ–™": lambda title, tags, content: f"""è¯·ç”Ÿæˆé€‚åˆçº¿ä¸‹å±•ç¤ºçš„æ–‡æ¡ˆï¼š
ğŸ–¼ï¸ åœºæ™¯ï¼šå±•é¦†/æˆ·å¤–å¹¿å‘Š
ğŸ“ è§„æ ¼ï¼šä¸»è§†è§‰ã€è¯´æ˜æ–‡æ¡ˆã€å¯¼è§ˆè®¾è®¡
ğŸ¨ è§†è§‰ï¼šä¼ ç»Ÿå…ƒç´ ç°ä»£å‘ˆç°
ğŸ“ åŸå§‹å†…å®¹ï¼š{content}
âœï¸ è¦æ±‚ï¼šå±‚æ¬¡åˆ†æ˜ï¼Œé‡ç‚¹çªå‡ºï¼Œé€‚åˆè¿œè¿‘è·ç¦»é˜…è¯»""",

    "ç ”å­¦æ´»åŠ¨": lambda title, tags, content: f"""è¯·è®¾è®¡ç ”å­¦æ´»åŠ¨æ–¹æ¡ˆï¼š
ğŸ’ å¯¹è±¡ï¼šé’å°‘å¹´ç¾¤ä½“
ğŸ“š æ¨¡å—ï¼šçŸ¥è¯†ä¼ æˆ+å®è·µä½“éªŒ+äº’åŠ¨æ¢ç©¶
ğŸ¯ ç›®æ ‡ï¼šå¯“æ•™äºä¹ï¼Œä¼ æ‰¿æ–‡åŒ–
ğŸ“ åŸå§‹å†…å®¹ï¼š{content}
âœï¸ è¦æ±‚ï¼šè®¾è®¡3ä¸ªè¯¾ç¨‹æ¨¡å—ï¼Œé…å¥—1ä¸ªå®è·µæ´»åŠ¨""",

    "å•†ä¸šåˆä½œ": lambda title, tags, content: f"""è¯·ç”Ÿæˆå•†ä¸šåˆä½œæ¨å¹¿æ–¹æ¡ˆï¼š
ğŸ’¼ å½¢å¼ï¼šå“ç‰Œè”å/æˆæƒåˆä½œ
ğŸ“ˆ äº®ç‚¹ï¼šæ–‡åŒ–IPä»·å€¼è½¬åŒ–
ğŸ¯ ç›®æ ‡ï¼šå•†ä¸šä»·å€¼ä¸æ–‡åŒ–ä¼ æ’­åŒèµ¢
ğŸ“ åŸå§‹å†…å®¹ï¼š{content}
âœï¸ è¦æ±‚ï¼šæ˜ç¡®å•†ä¸šæƒç›Šï¼Œè®¾å®šè¥é”€æŒ‡æ ‡""",

    "å­¦æœ¯ç ”ç©¶": lambda title, tags, content: f"""è¯·ç”Ÿæˆå­¦æœ¯ç ”ç©¶æŠ¥å‘Šï¼š
ğŸ“ ç±»å‹ï¼šæ–‡åŒ–ä¼ æ’­ç ”ç©¶/ä¿æŠ¤ç ”ç©¶
ğŸ“š æ¡†æ¶ï¼šç†è®ºä¾æ®+ç ”ç©¶æ–¹æ³•+æ•°æ®åˆ†æ
ğŸ” é‡ç‚¹ï¼šæ–‡åŒ–ä»·å€¼ç ”ç©¶ä¸ä¼ æ’­æ•ˆæœè¯„ä¼°
ğŸ“ åŸå§‹å†…å®¹ï¼š{content}
âœï¸ è¦æ±‚ï¼šå­¦æœ¯è§„èŒƒï¼Œéœ€æœ‰ç†è®ºæ”¯æ’‘å’Œæ•°æ®è®ºè¯"""
}

# åˆ¤æ–­å†…å®¹æ˜¯è‰ç¨¿è¿˜æ˜¯éœ€æ±‚æè¿°
def detect_content_type(content: str) -> str:
    if len(content.strip()) < 50 or any(keyword in content for keyword in ["ç›®æ ‡", "å—ä¼—", "å¯¹è±¡", "æ¸ é“", "é™åˆ¶", "äººç¾¤"]):
        return "éœ€æ±‚è¯´æ˜"
    elif "ã€‚" in content or "ï¼Œ" in content:
        return "è‰ç¨¿æ–‡"
    else:
        return "ä¸ç¡®å®š"

def generate_simple_report(data):
    """ç”Ÿæˆå®£ä¼ æ–‡æ¡ˆçš„ä¸»å‡½æ•°"""
    try:
        # è·å–åŸºæœ¬ä¿¡æ¯
        tags = ", ".join(data.get("tags", []))
        title = data["title"]
        content = data["content"]
        platform = data["platform"]  # æ–°å¢ï¼šæŒ‡å®šå¹³å°
        
        # æ ¹æ®å¹³å°é€‰æ‹©å¯¹åº”çš„æç¤ºæ¨¡æ¿
        if platform in PLATFORM_PROMPTS:
            prompt = PLATFORM_PROMPTS[platform](title, tags, content)
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„å¹³å°ç±»å‹ï¼š{platform}")

        # è°ƒç”¨ LLM
        response = client.chat.completions.create(
            model="glm-4",
            messages=[{"role": "user", "content": prompt}]
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"ç”Ÿæˆå¤±è´¥ï¼š{str(e)}"

@require_http_methods(["POST"])
def generate_publicity_report(request):
    """å¤„ç†ç”Ÿæˆå®£ä¼ æŠ¥å‘Šçš„è¯·æ±‚"""
    try:
        data = json.loads(request.body)
        
        # éªŒè¯å¿…è¦å­—æ®µ
        required_fields = ["title", "content", "platform", "tags"]
        for field in required_fields:
            if field not in data:
                return JsonResponse({
                    'code': 400,
                    'message': f'ç¼ºå°‘å¿…è¦å­—æ®µï¼š{field}',
                    'data': None
                })
        
        # éªŒè¯å¹³å°ç±»å‹
        if data["platform"] not in PLATFORM_PROMPTS:
            return JsonResponse({
                'code': 400,
                'message': f'ä¸æ”¯æŒçš„å¹³å°ç±»å‹ï¼š{data["platform"]}',
                'data': None
            })
        
        # ç”ŸæˆæŠ¥å‘Š
        report = generate_simple_report(data)
        
        return JsonResponse({
            'code': 200,
            'message': 'success',
            'data': {
                'report': report,
                'platform': data["platform"]
            }
        })
    except json.JSONDecodeError:
        return JsonResponse({
            'code': 400,
            'message': 'æ— æ•ˆçš„JSONæ ¼å¼',
            'data': None
        })
    except Exception as e:
        return JsonResponse({
            'code': 500,
            'message': f'ç”ŸæˆæŠ¥å‘Šå¤±è´¥ï¼š{str(e)}',
            'data': None
        })

# æµ‹è¯•æ•°æ®
test_data = {
    "tags": ["æ¹–æ¹˜æ–‡åŒ–", "éé—ä¼ æ‰¿"],
    "title": "åƒå¹´ç‘¶æ—ä¼ ç»Ÿï¼Œè—åœ¨æ¹˜è¥¿æ·±å¤„çš„æ–‡åŒ–ç‘°å®",
    "content": "ç‘¶æ—ä¼ ç»Ÿæ–‡åŒ–å±•ç¤ºæ´»åŠ¨å°†åœ¨æ¹˜è¥¿ä¸¾è¡Œï¼Œå±•ç¤ºç‘¶æ—ä¼ ç»Ÿæœé¥°åˆ¶ä½œã€æ­Œèˆè¡¨æ¼”ç­‰éç‰©è´¨æ–‡åŒ–é—äº§ã€‚",
    "platform": "å°çº¢ä¹¦"  # æŒ‡å®šå¹³å°
}

if __name__ == "__main__":
    result = generate_simple_report(test_data)
    print("\nğŸ“£ ç”Ÿæˆçš„å®£ä¼ æ–‡æ¡ˆå¦‚ä¸‹ï¼š\n")
    print(result)